{% extends "base.html" %}
{% block content %}
<style>
    .keyboard {
        display: flex;
        flex-direction: column;
        width: 100%;
        max-width: 800px;
    }

    .keyboard-row {
        display: flex;
        gap: 5px;
        margin-bottom: 5px;
    }

    .keyboard-row button {
        flex: 1;
        padding: 10px;
        font-size: 16px;
    }

    .moves-display {
        width: 100%;
        max-width: 800px;
        min-height: 150px;
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 15px;
        font-family: monospace;
        font-size: 16px;
    }

    .side-selector {
        margin-bottom: 15px;
    }

    .side-selector button {
        padding: 8px 16px;
        margin-right: 10px;
        font-size: 16px;

    }

    .side-selector button.selected {
        background-color: #4CAF50;
        color: white
    }
</style>

<h2>Puzzle #{{ puzzle_number }}</h2>

<div class="side-selector">
    <button id="whiteToMove" onclick="SetSideToMove('white')">White to
        move</button>
    <button id="blackToMove" onclick="SetSideToMove('black')">Black to
        move</button>
</div>

<div class="navigation buttons">
    <button id="back" onclick="navigateBack()"> Move back</button>
    <button id="forward" onclick="navigateForward()">Move forward</button>
</div>

<div id="movesDisplay" class="moves-display">
</div>


<div class="keyboard">
    <div class="keyboard-row">
        <button onclick="insertText('K')">K</button>
        <button onclick="insertText('Q')">Q</button>
        <button onclick="insertText('R')">R</button>
        <button onclick="insertText('B')">B</button>
        <button onclick="insertText('N')">N</button>
        <button onclick="insertText('x')">x</button>
        <button onclick="insertText('+')">+</button>
        <button onclick="insertText('\n')">Enter</button>
    </div>
    <div class="keyboard-row">
        <button onclick="insertText('a')">a</button>
        <button onclick="insertText('b')">b</button>
        <button onclick="insertText('c')">c</button>
        <button onclick="insertText('d')">d</button>
        <button onclick="insertText('e')">e</button>
        <button onclick="insertText('f')">f</button>
        <button onclick="insertText('g')">g</button>
        <button onclick="insertText('h')">h</button>
    </div>
    <div class="keyboard-row">
        <button onclick="insertText('1')">1</button>
        <button onclick="insertText('2')">2</button>
        <button onclick="insertText('3')">3</button>
        <button onclick="insertText('4')">4</button>
        <button onclick="insertText('5')">5</button>
        <button onclick="insertText('6')">6</button>
        <button onclick="insertText('7')">7</button>
        <button onclick="insertText('8')">8</button>
    </div>
    <div class="keyboard-row">
        <button onclick="insertText('#')">#</button>
        <button onclick="insertText('?')">?</button>
        <button onclick="insertText('!')">!</button>
        <button onclick="insertText('=')">=</button>
        <button onclick="insertText('-')">-</button>
        <button onclick="insertText(' ')">Space</button>
        <button onclick="deleteLastChar()">Backspace</button>
    </div>
</div>

<script>
    //track moves 
    let virtualRoot = {
        move:null,
        parent: null,
        children:[]
                }
    let activeNode = virtualRoot;
    let currentMove = '';
    let activeChildIndex = 0;
    let sideline = [];
    let inPrincipalVariation = true;
    window.sideToMove = 'white'
    document.getElementById('whiteToMove').classList.add('selected');
    updateDisplay()

    function insertText(char) {
        let moveFound = false;
        if (char === ' ' || char === '\n') {
            if (currentMove.length > 0) {
                for (let i=0; i<activeNode.children.length; i++) {
                    if (currentMove===activeNode.children[i].move){
                        activeNode = activeNode.children[i]
                        moveFound = true;
                        currentMove='';
                        break;
                    }
                }
            }
            if (!moveFound) {
                    let node = createNode(currentMove, activeNode);
                    activeNode.children.push(node);
                    activeNode = node;
                    currentMove = '';
            }
        } else {
        //add character to current move
        currentMove += char;   
        }
        updateDisplay();
        }
    

    function updateDisplay() {
        if (inPrincipalVariation) {
            //Build two-column layout for PV
            let html = '<div style="font-size: 20px;">';
            let nodes = [];
            let rewindNode = activeNode;
            let sideline = [];

            while (rewindNode) {
                if (rewindNode.move){
                    nodes.push(rewindNode);   
                } 
                rewindNode = rewindNode.parent;
            }     
            nodes.reverse()
            activeNodeIndex = nodes.length - 1;
            let forwardNode = activeNode
            
            if (forwardNode) {
                while (forwardNode.children.length>=1){
                    forwardNode = forwardNode.children[0];
                    nodes.push(forwardNode);
                }  
               
                }
            let sidelineChecker = virtualRoot;
            let indexCounter = 0
            
            while (sidelineChecker.children.length >=1) {
                for (let i=1; i<sidelineChecker.children.length; i++){
                    sideline.push({index:indexCounter, color: (indexCounter%2===0) ? 'white':'black', node:altNodes(sidelineChecker.children[i])});
                } indexCounter++; 
                sidelineChecker = sidelineChecker.children[0];
            } 
            
                
            
            let moveIndex = 0;

            
            //Check if white or black moves first
            let whiteFirst = (window.sideToMove === 'white');
            //Loop through moves creating rows
            while (moveIndex < nodes.length) {
                html += '<div style="display: flex; margin-bottom: 5px;">';
                // White's column
                if (whiteFirst) {
                    if(moveIndex===activeNodeIndex+1) {
                    html += '<div style="width: 200px; padding: 5px; border: 2px solid blue ">' +
                        nodes[moveIndex].move + '</div>';
                    } else {
                    html += '<div style="width: 200px; padding: 5px; ">' +
                        nodes[moveIndex].move + '</div>';
                    }
                }else {
                    //black moves first - first row is empty, others use 
                    // moves[moveIndex]
                    if (moveIndex === 0) {
                        html += '<div style="width: 200px; padding: 5px;' +
                            '"></div>';
                    }
                    else {
                        if (moveIndex===activeNodeIndex+1) {
                        html += '<div style="width: 200px; padding: 5px; border: 2px solid blue">' +
                            nodes[moveIndex].move + '</div>';
                        }else {
                            html += '<div style="width: 200px; padding: 5px; ">' +
                            nodes[moveIndex].move + '</div>';
                        } 
                    }
                }
                // Black's column
                if (!whiteFirst && moveIndex === 0) {
                    if (moveIndex===activeNodeIndex+1){
                        html += '<div style="width: 200px; padding: 5px; border:2px solid blue">' +
                        nodes[moveIndex].move + '</div>';
                    }else{
                    html += '<div style="width: 200px; padding: 5px;">' +
                        nodes[moveIndex].move + '</div>';
                    }
                }
                else if (moveIndex + 1 < nodes.length) {
                    if (moveIndex===activeNodeIndex) {
                        if (currentMove.length>0) {
                         html += '<div style="width: 200px; padding: 5px; border: 2px solid blue; color:' +
                        ' gray;">' + currentMove + '</div>';
                        } else { 
                        html += '<div style="width: 200px; padding: 5px; border:2px solid blue">' +
                        nodes[moveIndex + 1].move + '</div>';
                        }    
                    } else {
                    html += '<div style="width: 200px; padding: 5px; border: 2px solid blue; min-height: 22px;>'
                         + nodes[moveIndex + 1].move + '</div>';
                    }
                }
        
                html += '</div>';
                if (sideline.length>0){
                for (let i=0; i<sideline.length; i++) {
                    if (sideline[i].index === moveIndex || sideline[i].index === moveIndex+1) {
                        if (sideline[i].color === 'white'){
                            html += '<div style="display: flex; margin-bottom: 4px;">';     
                            html += '<div style="width: 200px; padding: 4px; min-height: 16px; font-size: 14px">' + sideline[i].node + '</div>';
                            html += '</div>';
                        } else {
                            html += '<div style="display: flex; margin-bottom: 4px;">';
                            html += '<div style="width: 200px; padding: 4px; min-height: 16px"></div>'
                            html += '<div style="width: 200px; padding: 4px; min-height: 16px; font-size: 14px">' + sideline[i].node + '</div>';
                            html += '</div>';
                        }
                        
                    }
                }
            }
                moveIndex += (!whiteFirst && moveIndex === 0) ? 1 : 2;
                
            }
            let iswhitesTurn = (whiteFirst && nodes.length % 2 === 0) ||
                    (!whiteFirst && nodes.length % 2 === 1);
            if (iswhitesTurn) {
                html += '<div style="display: flex; margin-bottom: 5px;">';
                    if (nodes.length===activeNodeIndex+1){
                         html += '<div style="width: 200px; padding: 5px; border: 2px solid blue; min-height: 22px; color:' +
                        'gray;">'
                        if (currentMove.length > 0) {
                            html += currentMove
                        }
                    html += '</div>';
                    } else {
                        html += '<div style="width: 200px; padding: 5px; min-height: 22px; color:' +
                        'gray;">'
                        if (currentMove.length > 0) {
                            html += currentMove
                        }
                    html += '</div>';
                    }
                html += '</div>';
                } else if (!iswhitesTurn && nodes.length === 0) {
                    html += '<div style="display: flex; margin-bottom: 5px;">';
                    html += '<div style="width: 200px; padding: 5px; color:' +
                        'gray;"></div>';    
                    html += '<div style="width: 200px; padding: 5px; border: 2px solid blue; min-height: 22px; color:' +
                            'gray;">' + currentMove + '</div>';
                    html += '</div>';
                        }
            html += '</div>';
            
            document.getElementById('movesDisplay').innerHTML = html;     
        }
    }

    function SetSideToMove(side) {
            //store which side is to move
            window.sideToMove = side;
            // Remove 'selected' class from both buttons
            document.getElementById('whiteToMove').classList.remove('selected');
            document.getElementById('blackToMove').classList.remove('selected')
            // Add 'selected' class to the clicked button 
            document.getElementById(side + 'ToMove').classList.add('selected');
            updateDisplay();

        }

        function deleteLastChar(){
            if (currentMove.length > 0) {
                currentMove = currentMove.slice(0,-1);
            }
            else if (activeNode!==virtualRoot) {
                currentMove = activeNode.move;
                activeNode.parent.children.pop()
                activeNode = activeNode.parent;
                }
            updateDisplay();
            }

        function navigateBack(){
            currentMove = '';
            if (activeNode!==virtualRoot) {
                activeNode = activeNode.parent;
            }
            updateDisplay();
        }

        function navigateForward(){
            currentMove = '';
            if (activeNode.children.length > 0) {
                    activeNode = activeNode.children[0];    
            }
            updateDisplay();
            } 

         function createNode(move, parent = null) {
            let node = {
                move: move,
                parent:parent,
                children: []
            }
            return node;
         }

         function createNodes(moves){
            let nodes = []
            
            for (let i = 0; i < moves.length; i++) {
                var move = moves[i];
                let node = createNode(move, i > 0 ? nodes[i-1] : null);
                nodes.push(node);
                if (i>0){
                    nodes[i-1].children.push(node)
                }
            }   
            return nodes;
         }

        function altNodes(node) {
            let string = '';
            string += node.move + ' ';
            while (node.children.length > 0) {
                node = node.children[0]
                string += node.move + ' ';
                }
             return string;
            }
        
      

</script>
{% endblock %}