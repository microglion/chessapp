{% extends "base.html" %}
{% block content %}
<style>
    .keyboard {
        display: flex;
        flex-direction: column;
        width: 100%;
        max-width: 800px;
    }

    .keyboard-row {
        display: flex;
        gap: 5px;
        margin-bottom: 5px;
    }

    .keyboard-row button {
        flex: 1;
        padding: 10px;
        font-size: 16px;
    }

    .moves-display {
        width: 100%;
        max-width: 800px;
        min-height: 150px;
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 15px;
        font-family: monospace;
        font-size: 16px;
    }

    .side-selector {
        margin-bottom: 15px;
    }

    .side-selector button {
        padding: 8px 16px;
        margin-right: 10px;
        font-size: 16px;

    }

    .side-selector button.selected {
        background-color: #4CAF50;
        color: white
    }
</style>

<h2>Puzzle #{{ puzzle_number }}</h2>

<div class="side-selector">
    <button id="whiteToMove" onclick="SetSideToMove('white')">White to
        move</button>
    <button id="blackToMove" onclick="SetSideToMove('black')">Black to
        move</button>
</div>

<div class="navigation buttons">
    <button id="back" onclick="navigateBack()"> Move back</button>
    <button id="forward" onclick="navigateForward()">Move forward</button>
</div>

<div id="movesDisplay" class="moves-display">
</div>


<div class="keyboard">
    <div class="keyboard-row">
        <button onclick="insertText('K')">K</button>
        <button onclick="insertText('Q')">Q</button>
        <button onclick="insertText('R')">R</button>
        <button onclick="insertText('B')">B</button>
        <button onclick="insertText('N')">N</button>
        <button onclick="insertText('x')">x</button>
        <button onclick="insertText('+')">+</button>
        <button onclick="insertText('\n')">Enter</button>
    </div>
    <div class="keyboard-row">
        <button onclick="insertText('a')">a</button>
        <button onclick="insertText('b')">b</button>
        <button onclick="insertText('c')">c</button>
        <button onclick="insertText('d')">d</button>
        <button onclick="insertText('e')">e</button>
        <button onclick="insertText('f')">f</button>
        <button onclick="insertText('g')">g</button>
        <button onclick="insertText('h')">h</button>
    </div>
    <div class="keyboard-row">
        <button onclick="insertText('1')">1</button>
        <button onclick="insertText('2')">2</button>
        <button onclick="insertText('3')">3</button>
        <button onclick="insertText('4')">4</button>
        <button onclick="insertText('5')">5</button>
        <button onclick="insertText('6')">6</button>
        <button onclick="insertText('7')">7</button>
        <button onclick="insertText('8')">8</button>
    </div>
    <div class="keyboard-row">
        <button onclick="insertText('#')">#</button>
        <button onclick="insertText('?')">?</button>
        <button onclick="insertText('!')">!</button>
        <button onclick="insertText('=')">=</button>
        <button onclick="insertText('-')">-</button>
        <button onclick="insertText(' ')">Space</button>
        <button onclick="deleteLastChar()">Backspace</button>
    </div>
</div>

<script>
    //track moves 
    let rootNode = null;
    let activeNode = null;
    let currentMove = '';
    let activeChildIndex = 0;
    let inPrincipalVariation = true;
    window.sideToMove = 'white'
    document.getElementById('whiteToMove').classList.add('selected');
    updateDisplay()

    function insertText(char) {
        if (char === ' ' || char === '\n') {
            if (currentMove.length > 0) {
                let node = createNode(currentMove, activeNode ? activeNode: null);
                if (rootNode === null){
                    rootNode = node;
                    activeNode = node;
                    currentMove = '';
                    updateDisplay()
                } else { 
                    activeNode.children.push(node);
                    activeNode = node;
                    currentMove = '';
                    updateDisplay()
                    }
                }
               
            } else {
           //add character to current move
            currentMove += char;
            updateDisplay()
        }
    }

    function updateDisplay() {
        if (inPrincipalVariation) {
            //Build two-column layout for PV
            let html = '<div style="font-size: 18px;">';
            let moves = [];
            let currentNode = rootNode;
            while (currentNode) {
                moves.push(currentNode.move);
                currentNode = currentNode.children[0] 
            } 

            let moveIndex = 0;
            //Check if white or black moves first
            let whiteFirst = (window.sideToMove === 'white');
            //Loop through moves creating rows
            while (moveIndex < moves.length) {
                html += '<div style="display: flex; margin-bottom: 5px;">';
                // White's column
                if (whiteFirst) {
                    html += '<div style="width: 200px; padding: 5px;">' +
                        moves[moveIndex] + '</div>';
                } else {
                    //black moves first - first row is empty, others use 
                    // moves[moveIndex]
                    if (moveIndex === 0) {
                        html += '<div style="width: 200px; padding: 5px;' +
                            '"></div>';
                    }
                    else {
                        html += '<div style="width: 200px; padding: 5px;">' +
                            moves[moveIndex] + '</div>';
                    }
                }
                // Black's column
                if (!whiteFirst && moveIndex === 0) {
                    html += '<div style="width: 200px; padding: 5px;">' +
                        moves[moveIndex] + '</div>';
                } else if (moveIndex + 1 < moves.length) {
                    html += '<div style="width: 200px; padding: 5px;">' +
                        moves[moveIndex + 1] + '</div>';
                } else if (currentMove.length>0) {
                    html += '<div style="width: 200px; padding: 5px; border: 2px solid blue; color:' +
                        ' gray;">' + currentMove + '</div>';
                    } else {
                    html += '<div style="width: 200px; padding: 5px; border: 2px solid blue; min-height: 22px;"></div>';
                }
                    
                moveIndex += (!whiteFirst && moveIndex === 0) ? 1 : 2;
                html += '</div>';
            }
            let iswhitesTurn = (whiteFirst && moves.length % 2 === 0) ||
                    (!whiteFirst && moves.length % 2 === 1);
            if (iswhitesTurn) {
                html += '<div style="display: flex; margin-bottom: 5px;">';
                html += '<div style="width: 200px; padding: 5px; border: 2px solid blue; min-height: 22px; color:' +
                        'gray;">'
                        if (currentMove.length > 0) {
                            html += currentMove
                        }
                html += '</div>';
                html += '</div>';
                } else if (!iswhitesTurn && moves.length === 0) {
                    html += '<div style="display: flex; margin-bottom: 5px;">';
                    html += '<div style="width: 200px; padding: 5px; color:' +
                        'gray;"></div>';    
                    html += '<div style="width: 200px; padding: 5px; border: 2px solid blue; min-height: 22px; color:' +
                        'gray;">' + currentMove + '</div>';
                    html += '</div>';

                }
            html += '</div>';
            document.getElementById('movesDisplay').innerHTML = html;
            }
                
        }
    
        function SetSideToMove(side) {
            //store which side is to move
            window.sideToMove = side;
            // Remove 'selected' class from both buttons
            document.getElementById('whiteToMove').classList.remove('selected');
            document.getElementById('blackToMove').classList.remove('selected')
            // Add 'selected' class to the clicked button 
            document.getElementById(side + 'ToMove').classList.add('selected');
            updateDisplay();

        }
        function deleteLastChar(){
            if (currentMove.length > 0) {
                currentMove = currentMove.slice(0,-1);
                updateDisplay();
            }
            else {
                currentMove = activeNode.move;
                
                if(activeNode === rootNode) {
                    activeNode = null;
                    rootNode = null;
                }else{
                activeNode.parent.children.pop()
                activeNode = activeNode.parent;

                }
                updateDisplay()
            }
        function navigateBack(){
            currentMove = '';
            if (activeNode.parent){
                activeNode = activeNode.parent;
                

            } else{
            }
            updateDisplay();
        }
        function navigateForward(){
            currentMove = '';
            if (activeNode.children.length > 0) {
                if (activeNode.children.length ===1) {
                    activeNode = activeNode.children[0];
                    
                } else if (activeNode.children.length >1){
                    if (activeChildIndex >= activeNode.children.length) {
                        activeChildIndex = 0;
                        }        
                        activeNode = activeNode.children[activeChildIndex]
                        activeChildIndex++;
                }
                updateDisplay();
                }
            }
         function createNode(move, parent = null) {
            let node = {
                move: move,
                parent:parent,
                children: []
            }
            return node;
         }
         function createNodes(moves){
            let nodes = []
            
            for (let i = 0; i < moves.length; i++) {
                var move = moves[i];
                let node = createNode(move, i > 0 ? nodes[i-1] : null);
                nodes.push(node);
                if (i>0){
                    nodes[i-1].children.push(node)
                }
            }
                
            return nodes;
         }
        

</script>
{% endblock %}